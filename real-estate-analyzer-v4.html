<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Analyzer - Pro Dashboard v4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-sidebar: #0f172a;
            --bg-main: #f1f5f9;
            --surface: #ffffff;
            --text-main: #334155;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 320px;
            background: var(--bg-sidebar);
            color: #f8fafc;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 1.5rem;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        /* --- SIDEBAR COMPONENTS --- */
        .logo {
            padding: 1.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            border-bottom: 1px solid #1e293b;
            color: white;
        }

        .section-title {
            padding: 1rem 1.5rem 0.5rem;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            color: #64748b;
            font-weight: 700;
        }

        .control-group {
            padding: 0.75rem 1.5rem;
        }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            color: #cbd5e1;
            margin-bottom: 0.4rem;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 0.6rem;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #1e293b;
            color: white;
            font-size: 0.9rem;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .market-selector-sidebar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .market-selector-sidebar button {
            flex: 1 1 calc(50% - 4px);
            min-width: 120px;
            padding: 0.6rem;
            border: 1px solid #334155;
            background: #1e293b;
            color: #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .market-selector-sidebar button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* --- MODAL --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--text-main);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-main);
            color: var(--text-main);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .market-list {
            margin-bottom: 2rem;
        }

        .market-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            background: var(--bg-main);
        }

        .market-list-item.default {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .market-info h4 {
            font-size: 1rem;
            color: var(--text-main);
            margin-bottom: 0.25rem;
        }

        .market-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .market-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* --- NAV TABS --- */
        .nav-tabs {
            display: flex;
            gap: 2rem;
            height: 100%;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            height: 100%;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: 0.2s;
            padding: 0 4px;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .nav-tab:hover {
            color: var(--primary-dark);
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: var(--bg-main);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* --- TABLES --- */
        .data-table-wrapper {
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: auto;
            max-height: 75vh;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #f1f5f9;
        }

        th.sortable::after {
            content: ' ‚Üï';
            color: #cbd5e1;
            font-size: 0.8rem;
        }

        th.sort-asc::after {
            content: ' ‚Üë';
            color: var(--primary);
        }

        th.sort-desc::after {
            content: ' ‚Üì';
            color: var(--primary);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: #f1f5f9;
        }

        .metric-good {
            color: var(--success);
            font-weight: 700;
        }

        .metric-bad {
            color: var(--danger);
            font-weight: 700;
        }

        /* --- CARDS --- */
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* --- STRESS TEST CARDS --- */
        .stress-card {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
        }

        .stress-card h4 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: var(--text-main);
        }

        .stress-result {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .stress-result:last-child {
            border-bottom: none;
        }

        .stress-label {
            color: var(--text-muted);
        }

        .stress-value {
            font-weight: 600;
        }

        .stress-value.positive {
            color: var(--success);
        }

        .stress-value.negative {
            color: var(--danger);
        }

        /* --- GRIDS --- */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        /* --- ALERTS --- */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
            font-weight: 500;
        }

        .alert-success {
            background: #f0fdf4;
            border-left-color: var(--success);
            color: #065f46;
        }

        .alert-danger {
            background: #fef2f2;
            border-left-color: var(--danger);
            color: #991b1b;
        }

        .alert-info {
            background: #eff6ff;
            border-left-color: var(--primary);
            color: #1e40af;
        }

        /* --- CHARTS --- */
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 1.5rem;
        }

        /* --- FORMS --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            padding: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group small {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* --- SUMMARY STATS --- */
        .summary-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .summary-stat {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .summary-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .summary-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        /* --- COMP ITEMS --- */
        .comp-item {
            background: var(--bg-main);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .comp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .comp-title {
            font-weight: 600;
            color: var(--text-main);
        }

        /* --- UTILITY --- */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-bar {
            padding: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 300px;
            font-size: 0.95rem;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }
            .grid-4 {
                grid-template-columns: 1fr 1fr;
            }
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">üè† Real Estate Analyzer <span style="font-weight:400; opacity:0.6; font-size:0.7em;">Pro v4</span></div>

        <div class="section-title">Market</div>
        <div class="control-group">
            <label>Select Market</label>
            <div class="market-selector-sidebar" id="market-selector-container">
                <!-- Market buttons will be dynamically inserted here -->
            </div>
            <button class="btn btn-warning" style="width:100%; margin-top:8px; font-size:0.85rem;" onclick="APP.openMarketModal()">‚öôÔ∏è Manage Markets</button>
        </div>

        <div class="section-title">Financing</div>
        <div class="control-group">
            <label>Down Payment (%)</label>
            <input type="number" id="g_down" value="25" oninput="APP.recalcAll()">
        </div>
        <div class="control-group">
            <label>Interest Rate (%)</label>
            <input type="number" id="g_rate" value="7.0" step="0.125" oninput="APP.recalcAll()">
        </div>
        <div class="control-group">
            <label>Loan Term (years)</label>
            <input type="number" id="g_term" value="30" oninput="APP.recalcAll()">
        </div>

        <div class="section-title">Operating Expenses</div>
        <div class="control-group">
            <label>Vacancy Rate (%)</label>
            <input type="number" id="g_vacancy" value="8" step="0.5" oninput="APP.recalcAll()">
        </div>
        <div class="control-group">
            <label>Property Management (%)</label>
            <input type="number" id="g_mgmt" value="10" step="0.5" oninput="APP.recalcAll()">
        </div>
        <div class="control-group">
            <label>Maintenance Reserve (%)</label>
            <input type="number" id="g_maint" value="10" step="0.5" oninput="APP.recalcAll()">
        </div>
        <div class="control-group">
            <label>CapEx Reserve (%)</label>
            <input type="number" id="g_capex" value="10" step="0.5" oninput="APP.recalcAll()">
        </div>

        <div class="section-title">Growth Assumptions</div>
        <div class="control-group">
            <label>Appreciation (%/year)</label>
            <input type="number" id="g_appr" value="3.0" step="0.1" oninput="APP.recalcAll()">
        </div>
        <div class="control-group">
            <label>Rent Growth (%/year)</label>
            <input type="number" id="g_rent_inc" value="3.0" step="0.1" oninput="APP.recalcAll()">
        </div>
        <div class="control-group">
            <label>Expense Growth (%/year)</label>
            <input type="number" id="g_exp_inc" value="3.0" step="0.1" oninput="APP.recalcAll()">
        </div>

        <div style="padding: 1.5rem;">
            <button class="btn btn-primary" style="width:100%; margin-bottom:8px;" onclick="APP.newProperty()">+ Add Property</button>
            <input type="file" id="csvInput" style="display:none" accept=".csv" onchange="APP.handleFileUpload(this)">
            <button class="btn btn-outline" style="width:100%; margin-bottom:8px;" onclick="document.getElementById('csvInput').click()">Import CSV</button>
            <button class="btn btn-outline" style="width:100%;" onclick="APP.exportProperties()">Export Data</button>
        </div>
    </aside>

    <div class="main-wrapper">
        <nav class="top-nav">
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="dashboard">Dashboard</div>
                <div class="nav-tab" data-tab="analysis">Detailed Analysis</div>
                <div class="nav-tab" data-tab="projections">Stress & Projections</div>
                <div class="nav-tab" data-tab="editor">Add / Edit</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="property-count" style="color: var(--text-muted); font-size: 0.9rem;">0 properties</span>
            </div>
        </nav>

        <div class="content-area">
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content active">
                <div style="margin-bottom: 1rem; display:flex; gap:1rem; align-items:center; justify-content:space-between;">
                    <input type="text" id="search" class="search-bar" placeholder="Search properties..." onkeyup="APP.renderDashboard()">
                    <button class="btn btn-danger btn-small" onclick="APP.clearAllData()">Clear All Data</button>
                </div>

                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="stat-total">0</div>
                        <div class="summary-stat-label">Total Properties</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="stat-passing">0</div>
                        <div class="summary-stat-label">Passing Hurdles</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="stat-avg-coc">0%</div>
                        <div class="summary-stat-label">Avg CoC Return</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="stat-total-cf">$0</div>
                        <div class="summary-stat-label">Total Monthly CF</div>
                    </div>
                </div>

                <div class="data-table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="address">Address</th>
                                <th class="sortable" data-sort="market">Market</th>
                                <th class="sortable" data-sort="purchasePrice">Price</th>
                                <th class="sortable" data-sort="bedrooms">BD/BR</th>
                                <th class="sortable" data-sort="calc.rent">Rent</th>
                                <th class="sortable" data-sort="calc.cf">Cash Flow</th>
                                <th class="sortable" data-sort="calc.coc">CoC %</th>
                                <th class="sortable" data-sort="calc.cap">Cap %</th>
                                <th class="sortable" data-sort="calc.dscr">DSCR</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- DETAILED ANALYSIS TAB -->
            <div id="tab-analysis" class="tab-content">
                <div id="anal-view" style="display:none;">
                    <h1 id="an-addr" style="margin-bottom:1rem;">Property</h1>

                    <div id="an-alert"></div>

                    <div class="grid-4" style="margin-bottom:1.5rem;">
                        <div class="card">
                            <div class="stat-label">Monthly Cash Flow</div>
                            <div class="stat-value" id="an-cf">$0</div>
                        </div>
                        <div class="card">
                            <div class="stat-label">Cash-on-Cash</div>
                            <div class="stat-value" id="an-coc">0%</div>
                        </div>
                        <div class="card">
                            <div class="stat-label">Cap Rate</div>
                            <div class="stat-value" id="an-cap">0%</div>
                        </div>
                        <div class="card">
                            <div class="stat-label">DSCR</div>
                            <div class="stat-value" id="an-dscr">0.00</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Income Analysis</div>
                        <table>
                            <tr>
                                <td>Gross Monthly Rent</td>
                                <td id="an-gross-rent" style="text-align:right;">$0</td>
                            </tr>
                            <tr>
                                <td>Gross Annual Income</td>
                                <td id="an-gross-annual" style="text-align:right;">$0</td>
                            </tr>
                            <tr>
                                <td>Vacancy Loss</td>
                                <td id="an-vacancy" style="text-align:right; color:var(--danger);">-$0</td>
                            </tr>
                            <tr style="font-weight: 600; background: var(--bg-main);">
                                <td>Effective Gross Income</td>
                                <td id="an-egi" style="text-align:right;">$0</td>
                            </tr>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">Operating Expenses</div>
                        <table id="an-expenses-table"></table>
                    </div>

                    <div class="card">
                        <div class="card-header">Financing & Cash Flow</div>
                        <table id="an-financing-table"></table>
                    </div>

                    <div id="an-comps-section"></div>
                </div>
                <div id="anal-none" style="text-align:center; padding:50px; color:var(--text-muted);">
                    <p style="font-size:1.2rem;">Please select a property from the Dashboard.</p>
                </div>
            </div>

            <!-- STRESS & PROJECTIONS TAB -->
            <div id="tab-projections" class="tab-content">
                <div id="proj-view" style="display:none;">
                    <h2 style="margin-bottom:1rem;">Stress Test Analysis</h2>

                    <div id="stress-alert"></div>

                    <div class="grid-3" style="margin-bottom:2rem;">
                        <div class="stress-card" id="stress-vacancy"></div>
                        <div class="stress-card" id="stress-expense"></div>
                        <div class="stress-card" id="stress-rent"></div>
                    </div>

                    <h2 style="margin-bottom:1rem;">10-Year Wealth Building Projections</h2>

                    <div class="alert alert-info" id="proj-summary"></div>

                    <div class="card">
                        <div class="card-header">Detailed Projections</div>
                        <div class="data-table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Rental Income</th>
                                        <th>Expenses</th>
                                        <th>NOI</th>
                                        <th>Cash Flow</th>
                                        <th>Principal Paid</th>
                                        <th>Loan Balance</th>
                                        <th>Property Value</th>
                                        <th>Equity</th>
                                    </tr>
                                </thead>
                                <tbody id="proj-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Cash Flow Over Time</div>
                        <div class="chart-container">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Equity Build-Up Over Time</div>
                        <div class="chart-container">
                            <canvas id="equityChart"></canvas>
                        </div>
                    </div>
                </div>
                <div id="proj-none" style="text-align:center; padding:50px; color:var(--text-muted);">
                    <p style="font-size:1.2rem;">Please select a property from the Dashboard.</p>
                </div>
            </div>

            <!-- ADD/EDIT TAB -->
            <div id="tab-editor" class="tab-content">
                <div class="card" style="max-width:900px; margin:auto;">
                    <h2 id="edit-title" style="margin-bottom:1.5rem;">Add Property</h2>
                    <input type="hidden" id="edit-id">

                    <h3 style="margin-bottom:1rem; color:var(--text-main); font-size:1rem;">Basic Information</h3>
                    <div class="form-grid" style="margin-bottom:1.5rem;">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="ed-addr">
                        </div>
                        <div class="form-group">
                            <label>Purchase Price ($)</label>
                            <input type="number" id="ed-price">
                        </div>
                        <div class="form-group">
                            <label>Square Feet</label>
                            <input type="number" id="ed-sqft">
                        </div>
                        <div class="form-group">
                            <label>Bedrooms</label>
                            <input type="number" id="ed-beds">
                        </div>
                        <div class="form-group">
                            <label>Bathrooms</label>
                            <input type="number" id="ed-baths" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Year Built</label>
                            <input type="number" id="ed-year">
                        </div>
                    </div>

                    <h3 style="margin-bottom:1rem; color:var(--text-main); font-size:1rem;">Income & Expenses (Optional Overrides)</h3>
                    <div class="form-grid" style="margin-bottom:1.5rem;">
                        <div class="form-group">
                            <label>Monthly Rent ($)</label>
                            <input type="number" id="ed-rent" placeholder="Leave blank for estimate">
                            <small>If blank, estimated at 1% of price</small>
                        </div>
                        <div class="form-group">
                            <label>Annual Property Tax ($)</label>
                            <input type="number" id="ed-tax" placeholder="Auto-calculated">
                        </div>
                        <div class="form-group">
                            <label>Annual Insurance ($)</label>
                            <input type="number" id="ed-insurance" placeholder="Auto-calculated">
                        </div>
                        <div class="form-group">
                            <label>HOA Fees ($/month)</label>
                            <input type="number" id="ed-hoa" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Utilities ($/month)</label>
                            <input type="number" id="ed-utilities" placeholder="0">
                            <small>If landlord pays</small>
                        </div>
                    </div>

                    <h3 style="margin-bottom:1rem; color:var(--text-main); font-size:1rem;">Comparable Properties</h3>
                    <div id="comps-container"></div>
                    <div class="button-group" style="margin-top:1rem; margin-bottom:1.5rem;">
                        <button class="btn btn-outline" onclick="APP.addComparable()">+ Add Comparable</button>
                        <button class="btn btn-outline" onclick="document.getElementById('compCsvFile').click()">Import CSV</button>
                        <input type="file" id="compCsvFile" accept=".csv" style="display:none" onchange="APP.importCompCSV(this)">
                    </div>

                    <div class="button-group">
                        <button class="btn btn-success" onclick="APP.saveProperty()">Save Property</button>
                        <button class="btn btn-outline" onclick="APP.switchTab('dashboard')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MARKET MANAGEMENT MODAL -->
    <div id="marketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Markets</h2>
                <button class="modal-close" onclick="APP.closeMarketModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="market-list" id="market-list">
                    <!-- Market list will be dynamically inserted -->
                </div>

                <h3 style="margin-bottom:1rem; color:var(--text-main);">Add New Market</h3>
                <div class="form-grid" style="margin-bottom:1rem;">
                    <div class="form-group">
                        <label>Market Name</label>
                        <input type="text" id="new-market-name" placeholder="e.g., Phoenix, AZ">
                    </div>
                    <div class="form-group">
                        <label>Property Tax Rate (%)</label>
                        <input type="number" id="new-market-tax" step="0.01" placeholder="1.0">
                    </div>
                    <div class="form-group">
                        <label>Annual Insurance ($)</label>
                        <input type="number" id="new-market-insurance" placeholder="2000">
                    </div>
                    <div class="form-group">
                        <label>Vacancy Rate (%)</label>
                        <input type="number" id="new-market-vacancy" step="0.5" placeholder="8">
                    </div>
                    <div class="form-group">
                        <label>Appreciation (%/year)</label>
                        <input type="number" id="new-market-appreciation" step="0.1" placeholder="3.0">
                    </div>
                    <div class="form-group">
                        <label>Rent Growth (%/year)</label>
                        <input type="number" id="new-market-rent-growth" step="0.1" placeholder="3.0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="APP.addMarket()">Add Market</button>
            </div>
        </div>
    </div>

    <script>
        // Default market presets (cannot be deleted)
        const DEFAULT_MARKETS = {
            tampa: {
                name: 'Tampa, FL',
                propertyTaxRate: 0.009,
                insurance: 2500,
                vacancyRate: 8,
                appreciation: 2.5,
                rentGrowth: 3.0,
                isDefault: true
            },
            atlanta: {
                name: 'Atlanta, GA',
                propertyTaxRate: 0.01,
                insurance: 1500,
                vacancyRate: 9,
                appreciation: 3.0,
                rentGrowth: 3.5,
                isDefault: true
            }
        };

        // Hurdle rates
        const HURDLE_RATES = {
            cashOnCash: 8.0,
            capRate: 6.0,
            dscr: 1.25
        };

        // Main application state
        const APP = {
            data: [],
            currentProperty: null,
            currentMarket: 'tampa',
            customMarkets: {},
            compCount: 0,
            sortColumn: null,
            sortDirection: 'asc',
            charts: {
                cashFlow: null,
                equity: null
            },

            init: function() {
                const saved = localStorage.getItem('savedProperties');
                if (saved) {
                    this.data = JSON.parse(saved);
                }

                const savedMarkets = localStorage.getItem('customMarkets');
                if (savedMarkets) {
                    this.customMarkets = JSON.parse(savedMarkets);
                }

                this.setupEventListeners();
                this.renderMarketSelector();
                this.recalcAll();
            },

            getAllMarkets: function() {
                return { ...DEFAULT_MARKETS, ...this.customMarkets };
            },

            getMarketPreset: function(marketId) {
                const allMarkets = this.getAllMarkets();
                return allMarkets[marketId] || DEFAULT_MARKETS.tampa;
            },

            setupEventListeners: function() {
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Table sorting
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.addEventListener('click', () => this.sortTable(th.dataset.sort));
                });

                // Auto-calculate fields
                document.getElementById('ed-price').addEventListener('input', (e) => {
                    const price = parseFloat(e.target.value) || 0;
                    const preset = this.getMarketPreset(this.currentMarket);
                    if (!document.getElementById('ed-tax').value) {
                        document.getElementById('ed-tax').placeholder = Math.round(price * preset.propertyTaxRate);
                    }
                    if (!document.getElementById('ed-insurance').value) {
                        document.getElementById('ed-insurance').placeholder = preset.insurance;
                    }
                });
            },

            renderMarketSelector: function() {
                const container = document.getElementById('market-selector-container');
                const allMarkets = this.getAllMarkets();

                let html = '';
                Object.entries(allMarkets).forEach(([id, market]) => {
                    const isActive = this.currentMarket === id;
                    html += `<button type="button" class="market-btn ${isActive ? 'active' : ''}" data-market="${id}" onclick="APP.selectMarket('${id}')">${market.name}</button>`;
                });

                container.innerHTML = html;
            },

            selectMarket: function(market) {
                this.currentMarket = market;
                this.renderMarketSelector();
                this.recalcAll();
            },

            openMarketModal: function() {
                document.getElementById('marketModal').classList.add('active');
                this.renderMarketList();
            },

            closeMarketModal: function() {
                document.getElementById('marketModal').classList.remove('active');
                // Clear form
                document.getElementById('new-market-name').value = '';
                document.getElementById('new-market-tax').value = '';
                document.getElementById('new-market-insurance').value = '';
                document.getElementById('new-market-vacancy').value = '';
                document.getElementById('new-market-appreciation').value = '';
                document.getElementById('new-market-rent-growth').value = '';
            },

            renderMarketList: function() {
                const container = document.getElementById('market-list');
                const allMarkets = this.getAllMarkets();

                let html = '';
                Object.entries(allMarkets).forEach(([id, market]) => {
                    const isDefault = market.isDefault;
                    html += `
                        <div class="market-list-item ${isDefault ? 'default' : ''}">
                            <div class="market-info">
                                <h4>${market.name} ${isDefault ? '(Default)' : ''}</h4>
                                <p>Tax: ${(market.propertyTaxRate * 100).toFixed(2)}% | Insurance: $${market.insurance} | Vacancy: ${market.vacancyRate}% | Appreciation: ${market.appreciation}%</p>
                            </div>
                            <div class="market-actions">
                                ${!isDefault ? `
                                    <button class="btn btn-outline btn-small" onclick="APP.editMarket('${id}')">Edit</button>
                                    <button class="btn btn-danger btn-small" onclick="APP.deleteMarket('${id}')">Delete</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            addMarket: function() {
                const name = document.getElementById('new-market-name').value.trim();
                const taxRate = parseFloat(document.getElementById('new-market-tax').value) / 100;
                const insurance = parseFloat(document.getElementById('new-market-insurance').value);
                const vacancy = parseFloat(document.getElementById('new-market-vacancy').value);
                const appreciation = parseFloat(document.getElementById('new-market-appreciation').value);
                const rentGrowth = parseFloat(document.getElementById('new-market-rent-growth').value);

                if (!name) {
                    alert('Please enter a market name');
                    return;
                }

                if (isNaN(taxRate) || isNaN(insurance) || isNaN(vacancy) || isNaN(appreciation) || isNaN(rentGrowth)) {
                    alert('Please fill in all fields with valid numbers');
                    return;
                }

                // Create market ID from name
                const marketId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');

                // Check if market already exists
                if (DEFAULT_MARKETS[marketId] || this.customMarkets[marketId]) {
                    alert('A market with this name already exists');
                    return;
                }

                this.customMarkets[marketId] = {
                    name,
                    propertyTaxRate: taxRate,
                    insurance,
                    vacancyRate: vacancy,
                    appreciation,
                    rentGrowth,
                    isDefault: false
                };

                localStorage.setItem('customMarkets', JSON.stringify(this.customMarkets));
                this.renderMarketList();
                this.renderMarketSelector();

                // Clear form
                document.getElementById('new-market-name').value = '';
                document.getElementById('new-market-tax').value = '';
                document.getElementById('new-market-insurance').value = '';
                document.getElementById('new-market-vacancy').value = '';
                document.getElementById('new-market-appreciation').value = '';
                document.getElementById('new-market-rent-growth').value = '';

                alert('Market added successfully!');
            },

            editMarket: function(marketId) {
                const market = this.customMarkets[marketId];
                if (!market) return;

                const name = prompt('Market Name:', market.name);
                if (!name) return;

                const taxRate = parseFloat(prompt('Property Tax Rate (%):', (market.propertyTaxRate * 100).toFixed(2)));
                const insurance = parseFloat(prompt('Annual Insurance ($):', market.insurance));
                const vacancy = parseFloat(prompt('Vacancy Rate (%):', market.vacancyRate));
                const appreciation = parseFloat(prompt('Appreciation (%/year):', market.appreciation));
                const rentGrowth = parseFloat(prompt('Rent Growth (%/year):', market.rentGrowth));

                if (isNaN(taxRate) || isNaN(insurance) || isNaN(vacancy) || isNaN(appreciation) || isNaN(rentGrowth)) {
                    alert('Invalid input. Market not updated.');
                    return;
                }

                this.customMarkets[marketId] = {
                    name,
                    propertyTaxRate: taxRate / 100,
                    insurance,
                    vacancyRate: vacancy,
                    appreciation,
                    rentGrowth,
                    isDefault: false
                };

                localStorage.setItem('customMarkets', JSON.stringify(this.customMarkets));
                this.renderMarketList();
                this.renderMarketSelector();
                this.recalcAll();
            },

            deleteMarket: function(marketId) {
                if (!confirm(`Are you sure you want to delete the market "${this.customMarkets[marketId].name}"?`)) {
                    return;
                }

                // If the deleted market is currently selected, switch to tampa
                if (this.currentMarket === marketId) {
                    this.currentMarket = 'tampa';
                }

                delete this.customMarkets[marketId];
                localStorage.setItem('customMarkets', JSON.stringify(this.customMarkets));
                this.renderMarketList();
                this.renderMarketSelector();
                this.recalcAll();
            },

            recalcAll: function() {
                const settings = {
                    downPayment: parseFloat(document.getElementById('g_down').value) / 100,
                    interestRate: parseFloat(document.getElementById('g_rate').value) / 100,
                    loanTerm: parseFloat(document.getElementById('g_term').value),
                    vacancy: parseFloat(document.getElementById('g_vacancy').value) / 100,
                    propertyMgmt: parseFloat(document.getElementById('g_mgmt').value) / 100,
                    maintenance: parseFloat(document.getElementById('g_maint').value) / 100,
                    capex: parseFloat(document.getElementById('g_capex').value) / 100,
                    appreciation: parseFloat(document.getElementById('g_appr').value) / 100,
                    rentGrowth: parseFloat(document.getElementById('g_rent_inc').value) / 100,
                    expenseGrowth: parseFloat(document.getElementById('g_exp_inc').value) / 100
                };

                this.data.forEach(prop => {
                    const metrics = this.calculateMetrics(prop, settings);
                    prop.calc = metrics;
                });

                this.renderDashboard();
                if (this.currentProperty) {
                    this.renderAnalysis();
                    this.renderProjections();
                }
            },

            calculateMetrics: function(property, settings) {
                const grossMonthlyIncome = property.monthlyRent || (property.purchasePrice * 0.01);
                const grossAnnualIncome = grossMonthlyIncome * 12;

                const vacancyLoss = grossAnnualIncome * settings.vacancy;
                const effectiveGrossIncome = grossAnnualIncome - vacancyLoss;

                const annualPropertyMgmt = grossAnnualIncome * settings.propertyMgmt;
                const annualMaintenance = grossAnnualIncome * settings.maintenance;
                const annualCapEx = grossAnnualIncome * settings.capex;
                const annualHOA = (property.hoaFees || 0) * 12;
                const annualUtilities = (property.utilities || 0) * 12;

                const marketPreset = this.getMarketPreset(property.market);
                const propertyTax = property.propertyTax || (property.purchasePrice * marketPreset.propertyTaxRate);
                const insurance = property.insurance || marketPreset.insurance;

                const totalOperatingExpenses = propertyTax + insurance + annualHOA +
                    annualPropertyMgmt + annualMaintenance + annualCapEx + annualUtilities;

                const noi = effectiveGrossIncome - totalOperatingExpenses;

                const downPayment = property.purchasePrice * settings.downPayment;
                const loanAmount = property.purchasePrice - downPayment;
                const closingCosts = property.purchasePrice * 0.03;
                const totalCashInvested = downPayment + closingCosts;

                const monthlyPayment = this.calculateMonthlyPayment(
                    loanAmount,
                    settings.interestRate,
                    settings.loanTerm
                );
                const annualDebtService = monthlyPayment * 12;

                const annualCashFlow = noi - annualDebtService;
                const monthlyCashFlow = annualCashFlow / 12;

                const cashOnCashReturn = (annualCashFlow / totalCashInvested) * 100;
                const capRate = (noi / property.purchasePrice) * 100;
                const dscr = noi / annualDebtService;

                return {
                    rent: grossMonthlyIncome,
                    grossAnnualIncome,
                    vacancyLoss,
                    effectiveGrossIncome,
                    totalOperatingExpenses,
                    annualPropertyMgmt,
                    annualMaintenance,
                    annualCapEx,
                    annualHOA,
                    annualUtilities,
                    propertyTax,
                    insurance,
                    noi,
                    monthlyPayment,
                    annualDebtService,
                    cf: monthlyCashFlow,
                    annualCashFlow,
                    totalCashInvested,
                    loanAmount,
                    coc: cashOnCashReturn,
                    cap: capRate,
                    dscr
                };
            },

            calculateMonthlyPayment: function(principal, annualRate, years) {
                const monthlyRate = annualRate / 12;
                const numPayments = years * 12;
                if (monthlyRate === 0) return principal / numPayments;
                return (principal * monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                       (Math.pow(1 + monthlyRate, numPayments) - 1);
            },

            calculate10YearProjections: function(property) {
                const settings = {
                    interestRate: parseFloat(document.getElementById('g_rate').value) / 100,
                    loanTerm: parseFloat(document.getElementById('g_term').value),
                    rentGrowth: parseFloat(document.getElementById('g_rent_inc').value) / 100,
                    expenseGrowth: parseFloat(document.getElementById('g_exp_inc').value) / 100,
                    appreciation: parseFloat(document.getElementById('g_appr').value) / 100,
                    vacancy: parseFloat(document.getElementById('g_vacancy').value) / 100,
                    propertyMgmt: parseFloat(document.getElementById('g_mgmt').value) / 100,
                    maintenance: parseFloat(document.getElementById('g_maint').value) / 100,
                    capex: parseFloat(document.getElementById('g_capex').value) / 100
                };

                const projections = [];
                let currentRent = property.calc.rent;
                let remainingBalance = property.calc.loanAmount;
                let currentValue = property.purchasePrice;

                const monthlyRate = settings.interestRate / 12;
                const monthlyPayment = property.calc.monthlyPayment;

                for (let year = 1; year <= 10; year++) {
                    const annualRent = currentRent * 12;
                    const vacancyLoss = annualRent * settings.vacancy;
                    const effectiveIncome = annualRent - vacancyLoss;

                    const yearlyPropertyTax = property.calc.propertyTax * Math.pow(1 + settings.expenseGrowth, year - 1);
                    const yearlyInsurance = property.calc.insurance * Math.pow(1 + settings.expenseGrowth, year - 1);
                    const yearlyHOA = property.calc.annualHOA * Math.pow(1 + settings.expenseGrowth, year - 1);
                    const yearlyUtilities = property.calc.annualUtilities * Math.pow(1 + settings.expenseGrowth, year - 1);

                    const yearlyPropertyMgmt = annualRent * settings.propertyMgmt;
                    const yearlyMaintenance = annualRent * settings.maintenance;
                    const yearlyCapEx = annualRent * settings.capex;

                    const yearExpenses = yearlyPropertyTax + yearlyInsurance + yearlyHOA +
                                        yearlyPropertyMgmt + yearlyMaintenance + yearlyCapEx + yearlyUtilities;

                    const noi = effectiveIncome - yearExpenses;
                    const annualDebtService = monthlyPayment * 12;

                    let principalPaydown = 0;
                    for (let month = 1; month <= 12; month++) {
                        const interestPayment = remainingBalance * monthlyRate;
                        const principalPayment = monthlyPayment - interestPayment;
                        principalPaydown += principalPayment;
                        remainingBalance -= principalPayment;
                    }

                    const cashFlow = noi - annualDebtService;
                    currentValue *= (1 + settings.appreciation);
                    const equity = currentValue - remainingBalance;

                    projections.push({
                        year,
                        rent: annualRent,
                        expenses: yearExpenses,
                        noi,
                        debtService: annualDebtService,
                        cashFlow,
                        principalPaydown,
                        remainingBalance,
                        propertyValue: currentValue,
                        equity,
                        cumulativeCashFlow: (projections[year - 2]?.cumulativeCashFlow || 0) + cashFlow
                    });

                    currentRent *= (1 + settings.rentGrowth);
                }

                return projections;
            },

            calculateStressTests: function(property) {
                const metrics = property.calc;
                const tests = {};

                // Vacancy spike (25%)
                const stressVacancy = 25;
                const stressVacancyLoss = metrics.grossAnnualIncome * (stressVacancy / 100);
                const stressVacancyIncome = metrics.grossAnnualIncome - stressVacancyLoss;
                const stressVacancyNOI = stressVacancyIncome - metrics.totalOperatingExpenses;
                const stressVacancyCashFlow = stressVacancyNOI - metrics.annualDebtService;

                tests.vacancySpike = {
                    scenario: `${stressVacancy}% vacancy rate`,
                    noi: stressVacancyNOI,
                    cashFlow: stressVacancyCashFlow,
                    monthlyCashFlow: stressVacancyCashFlow / 12,
                    passes: stressVacancyCashFlow > 0
                };

                // Expense surge (17.5%)
                const expenseIncrease = 17.5;
                const stressExpenses = metrics.totalOperatingExpenses * (1 + expenseIncrease / 100);
                const stressExpenseNOI = metrics.effectiveGrossIncome - stressExpenses;
                const stressExpenseCashFlow = stressExpenseNOI - metrics.annualDebtService;

                tests.expenseSurge = {
                    scenario: `${expenseIncrease}% expense increase`,
                    noi: stressExpenseNOI,
                    cashFlow: stressExpenseCashFlow,
                    monthlyCashFlow: stressExpenseCashFlow / 12,
                    passes: stressExpenseCashFlow > 0
                };

                // Rent decrease (12.5%)
                const rentDecrease = 12.5;
                const stressRent = metrics.grossAnnualIncome * (1 - rentDecrease / 100);
                const vacancy = parseFloat(document.getElementById('g_vacancy').value) / 100;
                const stressRentVacancy = stressRent * vacancy;
                const stressRentIncome = stressRent - stressRentVacancy;
                const stressRentNOI = stressRentIncome - metrics.totalOperatingExpenses;
                const stressRentCashFlow = stressRentNOI - metrics.annualDebtService;

                tests.rentDecrease = {
                    scenario: `${rentDecrease}% rent decrease`,
                    noi: stressRentNOI,
                    cashFlow: stressRentCashFlow,
                    monthlyCashFlow: stressRentCashFlow / 12,
                    passes: stressRentCashFlow > 0
                };

                return tests;
            },

            renderDashboard: function() {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';

                const searchTerm = document.getElementById('search').value.toLowerCase();
                let filteredData = this.data.filter(p =>
                    p.address.toLowerCase().includes(searchTerm)
                );

                // Apply sorting
                if (this.sortColumn) {
                    filteredData.sort((a, b) => {
                        let aVal = this.getNestedValue(a, this.sortColumn);
                        let bVal = this.getNestedValue(b, this.sortColumn);

                        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                        if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
                        if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                // Update summary stats
                const passing = filteredData.filter(p =>
                    p.calc.coc >= HURDLE_RATES.cashOnCash &&
                    p.calc.cap >= HURDLE_RATES.capRate &&
                    p.calc.dscr >= HURDLE_RATES.dscr
                ).length;

                const avgCoC = filteredData.length > 0
                    ? filteredData.reduce((sum, p) => sum + (p.calc.coc || 0), 0) / filteredData.length
                    : 0;

                const totalCF = filteredData.reduce((sum, p) => sum + (p.calc.cf || 0), 0);

                document.getElementById('stat-total').textContent = filteredData.length;
                document.getElementById('stat-passing').textContent = passing;
                document.getElementById('stat-avg-coc').textContent = avgCoC.toFixed(1) + '%';
                document.getElementById('stat-total-cf').textContent = '$' + Math.round(totalCF).toLocaleString();
                document.getElementById('property-count').textContent = `${filteredData.length} properties`;

                filteredData.forEach(p => {
                    const passesAll = p.calc.coc >= HURDLE_RATES.cashOnCash &&
                                     p.calc.cap >= HURDLE_RATES.capRate &&
                                     p.calc.dscr >= HURDLE_RATES.dscr;

                    const marketPreset = this.getMarketPreset(p.market);
                    const marketName = marketPreset.name;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><b>${p.address}</b></td>
                        <td>${marketName}</td>
                        <td>$${p.purchasePrice.toLocaleString()}</td>
                        <td>${p.bedrooms}/${p.bathrooms}</td>
                        <td>$${Math.round(p.calc.rent).toLocaleString()}</td>
                        <td class="${p.calc.cf > 0 ? 'metric-good' : 'metric-bad'}">$${Math.round(p.calc.cf).toLocaleString()}</td>
                        <td class="${p.calc.coc >= HURDLE_RATES.cashOnCash ? 'metric-good' : 'metric-bad'}">${p.calc.coc.toFixed(1)}%</td>
                        <td class="${p.calc.cap >= HURDLE_RATES.capRate ? 'metric-good' : 'metric-bad'}">${p.calc.cap.toFixed(1)}%</td>
                        <td class="${p.calc.dscr >= HURDLE_RATES.dscr ? 'metric-good' : 'metric-bad'}">${p.calc.dscr.toFixed(2)}</td>
                        <td style="text-align:center; font-weight:bold; color:${passesAll ? 'var(--success)' : 'var(--danger)'}">${passesAll ? '‚úì' : '‚úó'}</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="APP.loadProperty('${p.id}')">View</button>
                            <button class="btn btn-outline btn-small" onclick="APP.editProperty('${p.id}')">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="APP.deleteProperty('${p.id}')">Del</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                this.saveData();
            },

            sortTable: function(column) {
                if (this.sortColumn === column) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortColumn = column;
                    this.sortDirection = 'asc';
                }

                // Update UI
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    if (th.dataset.sort === column) {
                        th.classList.add(this.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });

                this.renderDashboard();
            },

            getNestedValue: function(obj, path) {
                return path.split('.').reduce((o, p) => o?.[p], obj);
            },

            loadProperty: function(id) {
                const prop = this.data.find(p => p.id === id);
                if (!prop) return;

                this.currentProperty = prop;
                this.switchTab('analysis');
                this.renderAnalysis();
            },

            renderAnalysis: function() {
                const p = this.currentProperty;
                if (!p) return;

                document.getElementById('anal-none').style.display = 'none';
                document.getElementById('anal-view').style.display = 'block';

                const marketPreset = this.getMarketPreset(p.market);
                document.getElementById('an-addr').textContent = `${p.address} - ${marketPreset.name}`;

                const passCoC = p.calc.coc >= HURDLE_RATES.cashOnCash;
                const passCap = p.calc.cap >= HURDLE_RATES.capRate;
                const passDSCR = p.calc.dscr >= HURDLE_RATES.dscr;
                const passAll = passCoC && passCap && passDSCR;

                document.getElementById('an-alert').innerHTML = passAll
                    ? '<div class="alert alert-success"><strong>‚úì PASSES All Hurdle Rates</strong> - This property meets your investment criteria</div>'
                    : '<div class="alert alert-danger"><strong>‚úó FAILS Hurdle Rates</strong> - This property does not meet minimum thresholds</div>';

                document.getElementById('an-cf').textContent = '$' + Math.round(p.calc.cf).toLocaleString();
                document.getElementById('an-coc').textContent = p.calc.coc.toFixed(2) + '%';
                document.getElementById('an-cap').textContent = p.calc.cap.toFixed(2) + '%';
                document.getElementById('an-dscr').textContent = p.calc.dscr.toFixed(2);

                document.getElementById('an-gross-rent').textContent = '$' + Math.round(p.calc.rent).toLocaleString();
                document.getElementById('an-gross-annual').textContent = '$' + Math.round(p.calc.grossAnnualIncome).toLocaleString();
                document.getElementById('an-vacancy').textContent = '-$' + Math.round(p.calc.vacancyLoss).toLocaleString();
                document.getElementById('an-egi').textContent = '$' + Math.round(p.calc.effectiveGrossIncome).toLocaleString();

                const vacancy = parseFloat(document.getElementById('g_vacancy').value);
                const mgmt = parseFloat(document.getElementById('g_mgmt').value);
                const maint = parseFloat(document.getElementById('g_maint').value);
                const capex = parseFloat(document.getElementById('g_capex').value);

                document.getElementById('an-expenses-table').innerHTML = `
                    <tr><td>Property Tax</td><td style="text-align:right;">$${Math.round(p.calc.propertyTax).toLocaleString()}</td></tr>
                    <tr><td>Insurance</td><td style="text-align:right;">$${Math.round(p.calc.insurance).toLocaleString()}</td></tr>
                    <tr><td>HOA Fees</td><td style="text-align:right;">$${Math.round(p.calc.annualHOA).toLocaleString()}</td></tr>
                    <tr><td>Property Management (${mgmt}%)</td><td style="text-align:right;">$${Math.round(p.calc.annualPropertyMgmt).toLocaleString()}</td></tr>
                    <tr><td>Maintenance Reserve (${maint}%)</td><td style="text-align:right;">$${Math.round(p.calc.annualMaintenance).toLocaleString()}</td></tr>
                    <tr><td>CapEx Reserve (${capex}%)</td><td style="text-align:right;">$${Math.round(p.calc.annualCapEx).toLocaleString()}</td></tr>
                    <tr><td>Utilities</td><td style="text-align:right;">$${Math.round(p.calc.annualUtilities).toLocaleString()}</td></tr>
                    <tr style="font-weight: 600; background: var(--bg-main);"><td>Total Operating Expenses</td><td style="text-align:right;">$${Math.round(p.calc.totalOperatingExpenses).toLocaleString()}</td></tr>
                    <tr style="font-weight: 600; background: var(--success); color: white;"><td>Net Operating Income (NOI)</td><td style="text-align:right;">$${Math.round(p.calc.noi).toLocaleString()}</td></tr>
                `;

                const down = parseFloat(document.getElementById('g_down').value);
                const rate = parseFloat(document.getElementById('g_rate').value);
                const term = parseFloat(document.getElementById('g_term').value);

                document.getElementById('an-financing-table').innerHTML = `
                    <tr><td>Purchase Price</td><td style="text-align:right;">$${p.purchasePrice.toLocaleString()}</td></tr>
                    <tr><td>Down Payment (${down}%)</td><td style="text-align:right;">$${Math.round(p.calc.totalCashInvested - (p.purchasePrice * 0.03)).toLocaleString()}</td></tr>
                    <tr><td>Loan Amount</td><td style="text-align:right;">$${Math.round(p.calc.loanAmount).toLocaleString()}</td></tr>
                    <tr><td>Closing Costs</td><td style="text-align:right;">$${Math.round(p.purchasePrice * 0.03).toLocaleString()}</td></tr>
                    <tr style="font-weight: 600; background: var(--bg-main);"><td>Total Cash Invested</td><td style="text-align:right;">$${Math.round(p.calc.totalCashInvested).toLocaleString()}</td></tr>
                    <tr style="height:12px;"></tr>
                    <tr><td>Monthly P&I Payment (${rate}%, ${term}yr)</td><td style="text-align:right;">$${Math.round(p.calc.monthlyPayment).toLocaleString()}</td></tr>
                    <tr><td>Annual Debt Service</td><td style="text-align:right;">$${Math.round(p.calc.annualDebtService).toLocaleString()}</td></tr>
                    <tr style="font-weight: 600; background: ${p.calc.annualCashFlow > 0 ? 'var(--success)' : 'var(--danger)'}; color: white;">
                        <td>Annual Cash Flow</td><td style="text-align:right;">$${Math.round(p.calc.annualCashFlow).toLocaleString()}</td>
                    </tr>
                `;

                // Comps section
                if (p.comparables && p.comparables.length > 0) {
                    let compsHtml = `
                        <div class="card">
                            <div class="card-header">Comparable Properties</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Address</th>
                                        <th>Sqft</th>
                                        <th>Beds/Baths</th>
                                        <th>Price</th>
                                        <th>$/Sqft</th>
                                        <th>Rent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${p.comparables.map(comp => `
                                        <tr>
                                            <td>${comp.address}</td>
                                            <td>${comp.sqft.toLocaleString()}</td>
                                            <td>${comp.beds}/${comp.baths}</td>
                                            <td>$${comp.price.toLocaleString()}</td>
                                            <td>$${(comp.price / comp.sqft).toFixed(0)}</td>
                                            <td>$${comp.rent.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    document.getElementById('an-comps-section').innerHTML = compsHtml;
                } else {
                    document.getElementById('an-comps-section').innerHTML = '';
                }
            },

            renderProjections: function() {
                const p = this.currentProperty;
                if (!p) return;

                document.getElementById('proj-none').style.display = 'none';
                document.getElementById('proj-view').style.display = 'block';

                const stressTests = this.calculateStressTests(p);
                const projections = this.calculate10YearProjections(p);

                // Stress tests
                const allPass = stressTests.vacancySpike.passes &&
                               stressTests.expenseSurge.passes &&
                               stressTests.rentDecrease.passes;

                document.getElementById('stress-alert').innerHTML = allPass
                    ? '<div class="alert alert-success"><strong>‚úì PASSES All Stress Tests</strong> - Property maintains positive cash flow under adverse conditions</div>'
                    : '<div class="alert alert-danger"><strong>‚úó FAILS Some Stress Tests</strong> - Property may not survive worst-case scenarios</div>';

                this.renderStressCard('stress-vacancy', 'üìâ Vacancy Spike', stressTests.vacancySpike);
                this.renderStressCard('stress-expense', 'üí∞ Expense Surge', stressTests.expenseSurge);
                this.renderStressCard('stress-rent', 'üìä Rent Decrease', stressTests.rentDecrease);

                // Projections summary
                const finalYear = projections[9];
                document.getElementById('proj-summary').innerHTML = `
                    <strong>Year 10 Summary:</strong> Property value of $${finalYear.propertyValue.toLocaleString()} with $${finalYear.equity.toLocaleString()} in equity.
                    Cumulative cash flow of $${finalYear.cumulativeCashFlow.toLocaleString()}.
                `;

                // Projections table
                const tbody = document.getElementById('proj-body');
                tbody.innerHTML = '';
                projections.forEach(proj => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${proj.year}</strong></td>
                        <td>$${Math.round(proj.rent).toLocaleString()}</td>
                        <td>$${Math.round(proj.expenses).toLocaleString()}</td>
                        <td>$${Math.round(proj.noi).toLocaleString()}</td>
                        <td style="color: ${proj.cashFlow > 0 ? 'var(--success)' : 'var(--danger)'}"><strong>$${Math.round(proj.cashFlow).toLocaleString()}</strong></td>
                        <td>$${Math.round(proj.principalPaydown).toLocaleString()}</td>
                        <td>$${Math.round(proj.remainingBalance).toLocaleString()}</td>
                        <td>$${Math.round(proj.propertyValue).toLocaleString()}</td>
                        <td><strong>$${Math.round(proj.equity).toLocaleString()}</strong></td>
                    `;
                    tbody.appendChild(tr);
                });

                // Charts
                setTimeout(() => {
                    this.createCashFlowChart(projections);
                    this.createEquityChart(projections);
                }, 100);
            },

            renderStressCard: function(elementId, title, test) {
                const html = `
                    <h4>${title}</h4>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">${test.scenario}</p>
                    <div class="stress-result">
                        <span class="stress-label">NOI</span>
                        <span class="stress-value">$${Math.round(test.noi).toLocaleString()}</span>
                    </div>
                    <div class="stress-result">
                        <span class="stress-label">Annual Cash Flow</span>
                        <span class="stress-value ${test.cashFlow > 0 ? 'positive' : 'negative'}">$${Math.round(test.cashFlow).toLocaleString()}</span>
                    </div>
                    <div class="stress-result">
                        <span class="stress-label">Monthly Cash Flow</span>
                        <span class="stress-value ${test.monthlyCashFlow > 0 ? 'positive' : 'negative'}">$${Math.round(test.monthlyCashFlow).toLocaleString()}</span>
                    </div>
                    <div class="stress-result">
                        <span class="stress-label">Result</span>
                        <span class="stress-value ${test.passes ? 'positive' : 'negative'}">${test.passes ? '‚úì PASS' : '‚úó FAIL'}</span>
                    </div>
                `;
                document.getElementById(elementId).innerHTML = html;
                document.getElementById(elementId).style.borderColor = test.passes ? 'var(--success)' : 'var(--danger)';
            },

            createCashFlowChart: function(projections) {
                const ctx = document.getElementById('cashFlowChart');
                if (!ctx) return;

                if (this.charts.cashFlow) {
                    this.charts.cashFlow.destroy();
                }

                this.charts.cashFlow = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: projections.map(p => `Year ${p.year}`),
                        datasets: [{
                            label: 'Annual Cash Flow',
                            data: projections.map(p => p.cashFlow),
                            borderColor: 'rgb(37, 99, 235)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Cumulative Cash Flow',
                            data: projections.map(p => p.cumulativeCashFlow),
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createEquityChart: function(projections) {
                const ctx = document.getElementById('equityChart');
                if (!ctx) return;

                if (this.charts.equity) {
                    this.charts.equity.destroy();
                }

                this.charts.equity = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: projections.map(p => `Year ${p.year}`),
                        datasets: [{
                            label: 'Loan Balance',
                            data: projections.map(p => p.remainingBalance),
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        }, {
                            label: 'Equity',
                            data: projections.map(p => p.equity),
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            },

            newProperty: function() {
                this.currentProperty = null;
                this.compCount = 0;
                document.getElementById('edit-title').textContent = 'Add Property';
                document.getElementById('edit-id').value = '';
                ['ed-addr', 'ed-price', 'ed-sqft', 'ed-beds', 'ed-baths', 'ed-year',
                 'ed-rent', 'ed-tax', 'ed-insurance', 'ed-hoa', 'ed-utilities'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('comps-container').innerHTML = '';
                this.switchTab('editor');
            },

            editProperty: function(id) {
                const prop = this.data.find(p => p.id === id);
                if (!prop) return;

                this.currentProperty = prop;
                this.compCount = 0;
                document.getElementById('edit-title').textContent = 'Edit Property';
                document.getElementById('edit-id').value = prop.id;

                document.getElementById('ed-addr').value = prop.address || '';
                document.getElementById('ed-price').value = prop.purchasePrice || '';
                document.getElementById('ed-sqft').value = prop.sqft || '';
                document.getElementById('ed-beds').value = prop.bedrooms || '';
                document.getElementById('ed-baths').value = prop.bathrooms || '';
                document.getElementById('ed-year').value = prop.yearBuilt || '';
                document.getElementById('ed-rent').value = prop.monthlyRent || '';
                document.getElementById('ed-tax').value = prop.propertyTax || '';
                document.getElementById('ed-insurance').value = prop.insurance || '';
                document.getElementById('ed-hoa').value = prop.hoaFees || '';
                document.getElementById('ed-utilities').value = prop.utilities || '';

                // Load comparables
                document.getElementById('comps-container').innerHTML = '';
                if (prop.comparables) {
                    prop.comparables.forEach(comp => {
                        this.addComparable();
                        const count = this.compCount;
                        document.getElementById(`comp${count}-addr`).value = comp.address;
                        document.getElementById(`comp${count}-sqft`).value = comp.sqft;
                        document.getElementById(`comp${count}-beds`).value = comp.beds;
                        document.getElementById(`comp${count}-baths`).value = comp.baths;
                        document.getElementById(`comp${count}-rent`).value = comp.rent;
                        document.getElementById(`comp${count}-price`).value = comp.price;
                    });
                }

                this.switchTab('editor');
            },

            addComparable: function() {
                this.compCount++;
                const container = document.getElementById('comps-container');
                const compDiv = document.createElement('div');
                compDiv.className = 'comp-item';
                compDiv.id = `comp-${this.compCount}`;
                compDiv.innerHTML = `
                    <div class="comp-header">
                        <span class="comp-title">Comparable #${this.compCount}</span>
                        <button class="btn btn-danger btn-small" onclick="APP.removeComp(${this.compCount})">Remove</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="comp${this.compCount}-addr">
                        </div>
                        <div class="form-group">
                            <label>Square Feet</label>
                            <input type="number" id="comp${this.compCount}-sqft">
                        </div>
                        <div class="form-group">
                            <label>Bedrooms</label>
                            <input type="number" id="comp${this.compCount}-beds">
                        </div>
                        <div class="form-group">
                            <label>Bathrooms</label>
                            <input type="number" id="comp${this.compCount}-baths" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Monthly Rent</label>
                            <input type="number" id="comp${this.compCount}-rent">
                        </div>
                        <div class="form-group">
                            <label>Price</label>
                            <input type="number" id="comp${this.compCount}-price">
                        </div>
                    </div>
                `;
                container.appendChild(compDiv);
            },

            removeComp: function(id) {
                document.getElementById(`comp-${id}`).remove();
            },

            getComparables: function() {
                const comps = [];
                for (let i = 1; i <= this.compCount; i++) {
                    const sqftEl = document.getElementById(`comp${i}-sqft`);
                    if (sqftEl && sqftEl.value) {
                        comps.push({
                            address: document.getElementById(`comp${i}-addr`).value,
                            sqft: parseFloat(sqftEl.value) || 0,
                            beds: parseFloat(document.getElementById(`comp${i}-beds`).value) || 0,
                            baths: parseFloat(document.getElementById(`comp${i}-baths`).value) || 0,
                            rent: parseFloat(document.getElementById(`comp${i}-rent`).value) || 0,
                            price: parseFloat(document.getElementById(`comp${i}-price`).value) || 0
                        });
                    }
                }
                return comps;
            },

            saveProperty: function() {
                const id = document.getElementById('edit-id').value || 'P' + Date.now();
                const address = document.getElementById('ed-addr').value;
                const price = parseFloat(document.getElementById('ed-price').value);

                if (!address || !price) {
                    alert('Please enter at least Address and Purchase Price');
                    return;
                }

                const prop = {
                    id,
                    address,
                    market: this.currentMarket,
                    purchasePrice: price,
                    sqft: parseFloat(document.getElementById('ed-sqft').value) || 0,
                    bedrooms: parseFloat(document.getElementById('ed-beds').value) || 0,
                    bathrooms: parseFloat(document.getElementById('ed-baths').value) || 0,
                    yearBuilt: parseFloat(document.getElementById('ed-year').value) || 0,
                    monthlyRent: parseFloat(document.getElementById('ed-rent').value) || null,
                    propertyTax: parseFloat(document.getElementById('ed-tax').value) || null,
                    insurance: parseFloat(document.getElementById('ed-insurance').value) || null,
                    hoaFees: parseFloat(document.getElementById('ed-hoa').value) || 0,
                    utilities: parseFloat(document.getElementById('ed-utilities').value) || 0,
                    comparables: this.getComparables()
                };

                const existingIndex = this.data.findIndex(p => p.id === id);
                if (existingIndex >= 0) {
                    this.data[existingIndex] = prop;
                } else {
                    this.data.push(prop);
                }

                this.recalcAll();
                this.switchTab('dashboard');
                alert('Property saved successfully!');
            },

            deleteProperty: function(id) {
                if (confirm('Are you sure you want to delete this property?')) {
                    this.data = this.data.filter(p => p.id !== id);
                    this.recalcAll();
                }
            },

            switchTab: function(tabName) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

                document.getElementById(`tab-${tabName}`).classList.add('active');
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                if (tabName === 'analysis' && !this.currentProperty) {
                    document.getElementById('anal-none').style.display = 'block';
                    document.getElementById('anal-view').style.display = 'none';
                }

                if (tabName === 'projections') {
                    if (this.currentProperty) {
                        this.renderProjections();
                    } else {
                        document.getElementById('proj-none').style.display = 'block';
                        document.getElementById('proj-view').style.display = 'none';
                    }
                }
            },

            saveData: function() {
                localStorage.setItem('savedProperties', JSON.stringify(this.data));
            },

            clearAllData: function() {
                if (confirm('Are you sure you want to delete all properties? This cannot be undone.')) {
                    this.data = [];
                    this.currentProperty = null;
                    this.saveData();
                    this.recalcAll();
                }
            },

            exportProperties: function() {
                if (this.data.length === 0) {
                    alert('No properties to export');
                    return;
                }
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `properties-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            },

            parseCSVLine: function(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            },

            handleFileUpload: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // Try JSON first
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            if (confirm(`Import ${imported.length} properties? This will add to existing properties.`)) {
                                this.data = [...this.data, ...imported];
                                this.recalcAll();
                                alert('Properties imported successfully!');
                            }
                        }
                    } catch {
                        // Try CSV
                        this.importCSV(e.target.result);
                    }
                };
                reader.readAsText(file);
                input.value = '';
            },

            importCSV: function(csvText) {
                const lines = csvText.trim().split(/\r?\n/);
                if (lines.length < 2) {
                    alert('CSV file appears to be empty');
                    return;
                }

                const header = this.parseCSVLine(lines[0]);
                const priceIdx = header.findIndex(h => h.toLowerCase().includes('price') && !h.toLowerCase().includes('per'));
                const addressIdx = header.findIndex(h => h.toLowerCase().includes('address'));
                const cityIdx = header.findIndex(h => h.toLowerCase().includes('city'));
                const sqftIdx = header.findIndex(h => h.toLowerCase().includes('square') || h.toLowerCase().includes('sqft'));
                const bedsIdx = header.findIndex(h => h.toLowerCase().includes('bed'));
                const bathsIdx = header.findIndex(h => h.toLowerCase().includes('bath'));

                let imported = 0;
                for (let i = 1; i < lines.length; i++) {
                    const row = this.parseCSVLine(lines[i]);
                    const price = row[priceIdx] ? parseFloat(row[priceIdx].replace(/[$,]/g, '')) : 0;
                    const address = row[addressIdx] || '';
                    const city = row[cityIdx] || '';
                    const sqft = row[sqftIdx] ? parseFloat(row[sqftIdx].replace(/[,sqft\s]/g, '')) : 0;
                    const beds = row[bedsIdx] ? parseFloat(row[bedsIdx]) : 3;
                    const baths = row[bathsIdx] ? parseFloat(row[bathsIdx]) : 2;

                    if (price > 0 && address) {
                        // Try to match city to existing market, default to tampa
                        let market = 'tampa';
                        const allMarkets = this.getAllMarkets();
                        const cityLower = city.toLowerCase();

                        for (const [id, marketData] of Object.entries(allMarkets)) {
                            if (marketData.name.toLowerCase().includes(cityLower)) {
                                market = id;
                                break;
                            }
                        }

                        this.data.push({
                            id: 'CSV' + Date.now() + i,
                            address: `${address}, ${city}`,
                            market,
                            purchasePrice: price,
                            sqft: sqft || 1500,
                            bedrooms: beds,
                            bathrooms: baths,
                            yearBuilt: 2000,
                            monthlyRent: null,
                            propertyTax: null,
                            insurance: null,
                            hoaFees: 0,
                            utilities: 0,
                            comparables: []
                        });
                        imported++;
                    }
                }

                if (imported > 0) {
                    this.recalcAll();
                    alert(`Successfully imported ${imported} properties from CSV!`);
                } else {
                    alert('No valid properties found in CSV');
                }
            },

            importCompCSV: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    if (lines.length < 2) {
                        alert('CSV file appears to be empty');
                        return;
                    }

                    const header = this.parseCSVLine(lines[0]);
                    const priceIdx = header.findIndex(h => h.toLowerCase().includes('price') && !h.toLowerCase().includes('per'));
                    const addressIdx = header.findIndex(h => h.toLowerCase().includes('address'));
                    const sqftIdx = header.findIndex(h => h.toLowerCase().includes('square') || h.toLowerCase().includes('sqft'));
                    const bedsIdx = header.findIndex(h => h.toLowerCase().includes('bed'));
                    const bathsIdx = header.findIndex(h => h.toLowerCase().includes('bath'));

                    let imported = 0;
                    for (let i = 1; i < lines.length && i < 51; i++) {
                        const row = this.parseCSVLine(lines[i]);
                        const price = row[priceIdx] ? parseFloat(row[priceIdx].replace(/[$,]/g, '')) : 0;
                        const address = row[addressIdx] || '';
                        const sqft = row[sqftIdx] ? parseFloat(row[sqftIdx].replace(/[,sqft\s]/g, '')) : 0;
                        const beds = row[bedsIdx] ? parseFloat(row[bedsIdx]) : 0;
                        const baths = row[bathsIdx] ? parseFloat(row[bathsIdx]) : 0;

                        if (price > 0 && sqft > 0) {
                            this.addComparable();
                            const count = this.compCount;
                            document.getElementById(`comp${count}-addr`).value = address;
                            document.getElementById(`comp${count}-sqft`).value = sqft;
                            document.getElementById(`comp${count}-beds`).value = beds;
                            document.getElementById(`comp${count}-baths`).value = baths;
                            document.getElementById(`comp${count}-price`).value = price;
                            imported++;
                        }
                    }

                    alert(`Successfully imported ${imported} comparable properties from CSV`);
                };
                reader.readAsText(file);
                input.value = '';
            }
        };

        // Initialize on load
        window.onload = () => APP.init();
    </script>
</body>
</html>
